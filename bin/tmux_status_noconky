#!/bin/bash

export MPD_HOST=192.168.0.15

function get_cpu_temp() {
    if [ -r "/sys/class/thermal/thermal_zone0/temp" ]; then
        temp=$(cat /sys/class/thermal/thermal_zone0/temp|awk '{ printf("%.0f", $1/1000) }')
        if [ -n "$temp" ]; then
            if [ "$temp" -gt 39 ]; then
                echo -n "#[fg=colour13]$temp°C"
            else
                echo -n "$temp°C"
            fi
        else
            echo -n "#[fg=colour15]-°C"
        fi
    else
        echo -n "#[fg=colour15]-°C"
    fi
}

function get_ip() {
    cachefile="${TMPDIR}/tmux.cache.ip"

    ping -c 1 mail.darookee.net > /dev/null 2>&1

    if [ $? -ne 0 ]; then
        echo "#[fg=colour9]OFFLINE"
        exit
    fi

    [[ -f $cachefile ]] || curl -s ipv4.ipchimp.net > $cachefile

    {
        filemtime=`stat -c %Y $cachefile`
        currtime=`date +%s`
        diff=$(( (currtime - filemtime) ))

        [[ "$diff" -lt "60" ]] || curl -s ipv4.ipchimp.net > $cachefile
    } &

    cat $cachefile
}

function get_weather_raw() {

    ## created by gnomeye 2012-01-05
    ## modified by darookee 2015-02-03
    ## Yahoo! needs OAUTH now
    ## Using external tool

    hash get_weather.sh > /dev/null || exit 1

    default="#[fg=colour2]✔#[fg=colour20]"
    sun="#[fg=colour3]☀#[fg=colour20]"
    snow="#[fg=colour6]❄#[fg=colour20]"
    rain="#[fg=colour7]☂#[fg=colour20]"
    cloud="#[fg=colour15]☁#[fg=colour20]"

    weather=$(~/.bin/get_weather.sh)

    condition=${weather%;*}
    temperatur=${weather#*;}

    metrdisplay="°C"

    case "$condition" in
        *Sun*|*sun*)
            emoji="$sun"
            ;;
        *Snow*|*snow*)
            emoji="$snow"
            ;;
        *storm*|*Storm*|*Rain*|*rain*|*Shower*|*shower*|*Drizzle*|*drizzle*)
            emoji="$rain"
            ;;
        *Cloud*|*cloud*)
            emoji="$cloud"
            ;;
        *)
            emoji="$default"
    esac

    printf "${emoji} ${temperatur}${metrdisplay}"
}

function get_weather() {
    cachefile="${TMPDIR}/tmux.cache.weather"

    [[ -f $cachefile ]] || get_weather_raw > $cachefile

    {
        filemtime=`stat -c %Y $cachefile`
        currtime=`date +%s`
        diff=$(( (currtime - filemtime) ))

        [[ "$diff" -lt "1800" ]] || get_weather_raw > $cachefile
    } &

    cat $cachefile
}

function get_mailcount() {
    maildir="${1-$HOME/.mail/INBOX/new}"

    if [ -e "$maildir" ]; then
        mcount=$(find $maildir -type f | wc -l)
        [[ "0" -lt "${mcount}" ]] && echo "${mcount}"
    fi

}

function get_battery() {
    batpath="/sys/class/power_supply/BAT0"

    if [ -d ${batpath} ]; then
        capacity=$(cat ${batpath}/capacity)
        state=$(cat ${batpath}/status)
        if [ "Charging" = "${state}" ]; then
            echo -n "#[fg=colour11] #[fg=colour15]"
        fi
        [[ "$capacity" -lt 30 ]] && echo -n "#[fg=colour13]  #[fg=colour15]"
        [[ "$capacity" -lt 50 ]] && echo -n "  "
        [[ "$capacity" -lt 70 ]] && echo -n "  "
        [[ "$capacity" -gt 90 ]] && echo -n "  "
    fi
}

function get_wifi() {
    if hash wpa_cli 2>/dev/null; then
        ssid=$(wpa_cli status ${1}|grep \^ssid|cut -d\= -f2)
        if [ ! -z "$ssid" ]; then
            echo "#[fg=colour10]  #[fg=colour15]${ssid}"
        fi
    fi
}

function get_volume() {
    if hash amixer 2>/dev/null; then
        state=$(amixer get Master|grep "o: P"|cut -d\  -f8|tr -dc 'onf')

        echo -n "#[fg=colour11]"
        if [[ "${state}" == "off" ]]; then
            echo -n ""
        else
            vol=$(amixer get Master|grep "o: P"|cut -d\  -f6|tr -dc '0-9')
            [[ ${vol} -ge 50 ]] && echo -n " " || echo -n " "
        fi
    fi
}

mail_count=$(get_mailcount ~/.mail/darookee/INBOX/new)

cpu_temp=$(get_cpu_temp)
cpu_percent=$(grep 'cpu ' /proc/stat | awk '{usage=($2+$4)*100/($2+$4+$5)} END {printf("%.0f%%", usage) }')
mem_percent=$(free | grep Mem | awk '{printf("%.0f%%", $4/$2 * 100.0)}')
cpu_load=$(uptime|cut -d, -f5|sed 's/ //')

cur_ip=$(get_ip)

space_home=$(df -h /home|grep "[0-9]"|awk '{ print $4 }')

battery=$(get_battery)
wifi=$(get_wifi)
volume=$(get_volume)

weather=$(get_weather)

date=$(date +"%a, %Y-%m-%d (%V)")
time=$(date +"%H:%M")

# MPDPi not working

if [ ! -z "${mail_count}" ]; then
    echo -n "#[bg=colour13]#[fg=colour7] ${mail_count} "
fi
echo -n "#[bg=colour8,fg=colour12] | "
# echo -n "#[bg=colour236,fg=colour174] ❤#[fg=colour188] ${cpu_temp} #[fg=colour188][${cpu_percent}]#[fg=colour245,bg=colour236]#[fg=colour188][${mem_percent}]"
echo -n "#[bg=colour8,fg=colour13]❤#[fg=colour15] ${cpu_temp} #[fg=colour15][${cpu_load}][${mem_percent}]#[fg=colour12] | "
if [ ! -z "${mpc}" ]; then
    echo -n "#[fg=colour11]♪ #[fg=colour15]${mpc}#[fg=colour12] | "
else
    echo -n "#[fg=colour10]⍟ #[fg=colour15]${cur_ip}#[fg=colour12] | "
    if [ ! -z "${wifi}" ]; then
        echo -n "${wifi}#[fg=colour12] | "
    fi
    echo -n "#[fg=colour10]≣ #[fg=colour15]${space_home}#[fg=colour12] | "
fi
if [ ! -z "${volume}" ]; then
    echo -n "#[fg=colour15]${volume}#[fg=colour12] | "
fi
if [ ! -z "${weather}" ]; then
    echo -n "${weather}#[fg=colour12] | "
fi
if [ ! -z "${battery}" ]; then
    echo -n "#[fg=colour15]${battery}#[fg=colour12]| "
fi
echo -n "#[fg=colour12]${date} #[fg=colour7]${time} "



