#!/bin/bash

function get_ip() {
    cachefile="${TMPDIR}/tmux.cache.ip"

    ping -n -q -c 1 -4 1.1.1.1 > /dev/null 2>&1

    if [ $? -ne 0 ]; then
        echo "#[fg=colour9]"
        rm $cachefile
        exit
    fi

    echo -n "#[fg=colour14] #[fg=colour15]"

    [[ -f $cachefile ]] || curl -s https://ifconfig.me > $cachefile

    {
        filemtime=`stat -c %Y $cachefile`
        currtime=`date +%s`
        diff=$(( (currtime - filemtime) ))

        [[ "$diff" -lt "3600" ]] || curl -s ipv4.ipchimp.net > $cachefile
    } &

    cat $cachefile
}

function get_weather_raw() {
    curl -s https://wttr.in/?format=1
}

function get_weather() {
    cachefile="${TMPDIR}/tmux.cache.weather"

    [[ -f $cachefile ]] || get_weather_raw > $cachefile

    {
        filemtime=`stat -c %Y $cachefile`
        currtime=`date +%s`
        diff=$(( (currtime - filemtime) ))

        [[ "$diff" -lt "10800" ]] || get_weather_raw > $cachefile
    } &

    cat $cachefile
}

function get_mailcount() {
    maildir="${1-$HOME/.mail/INBOX/new}"

    if [ -e "$maildir" ]; then
        mcount=$(find $maildir -type f | wc -l)
        [[ "0" -lt "${mcount}" ]] && echo "${mcount}"
    fi

}

local_status=""

if [ -x ~/.bin.untracked/get_local_status.sh ]; then
    local_status=$(~/.bin.untracked/get_local_status.sh)
fi

mail_count=$(get_mailcount ~/.mail/darookee/INBOX/new)

cpu_load=$(LC_NUMERIC=de_DE uptime|cut -d, -f5|sed 's/ //')
mem_percent=$(free | grep Mem | awk '{printf("%.0f%%", $3/$2 * 100.0)}')
space_home=$(df -h $HOME|grep "[0-9]"|awk '{ print $4 }')

cur_ip=$(get_ip)

weather=$(get_weather)
date=$(date +"%a, %Y-%m-%d (%V)")
time=$(date +"%H:%M")

if [ ! -z "${local_status}" ]; then
    echo -n "#[bg=colour3]#[fg=colour8] ${local_status} "
fi

if [ ! -z "${mail_count}" ]; then
    echo -n "#[bg=colour3]#[fg=colour1] #[fg=colour16]﯍ ${mail_count} "
fi

echo -n "#[bg=colour59,fg=colour12] "

echo -n "#[bg=colour59]"

echo -n "#[fg=colour9] #[fg=colour15]${cpu_load}#[fg=colour12] | "
echo -n "#[fg=colour10] #[fg=colour15]${mem_percent}#[fg=colour12] | "

echo -n "#[fg=colour11] #[fg=colour15]${space_home}#[fg=colour12] | "
echo -n "#[fg=colour15]${cur_ip}#[fg=colour12] "

echo -n "#[bg=colour0,fg=colour15] ${weather} "

echo -n "#[bg=colour13,fg=colour15] #[bg=colour13,fg=colour11] ${date}#[fg=colour7] ${time} "
